<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Calculateur - Prix transport</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { 
      font-family: Arial, sans-serif; 
      margin: 30px; 
      background: #f9f9f9; 
    }
    .header { display: flex; justify-content: space-between; align-items: center; max-width: 700px; margin: 0 auto 20px auto; }
    .header h1 { margin: 0; color: #222; font-size: 24px; text-align: left; }
    .header img { height: 60px; }
    table { border-collapse: collapse; margin: 20px auto; background: #fff; border-radius: 10px; overflow: hidden; width: 100%; max-width: 700px; }
    td { padding: 10px 15px; border: 1px solid #ddd; vertical-align: top; }
    th { background: #e0e0e0; text-align: left; padding: 10px 15px; font-size: 16px; color: #222; border: 1px solid #ddd; }
    label { font-weight: 600; }
    input[type="number"], select { width: 100%; padding: 6px; border: 1px solid #bbb; border-radius: 6px; font-size: 14px; }
    .btn { display: block; margin: 20px auto; background: #D7F502; color: #222; border: none; padding: 12px 20px; font-size: 16px; font-weight: bold; border-radius: 8px; cursor: pointer; }
    .btn:hover { background: #c4df00; }
    .result { margin-top: 25px; max-width: 500px; margin-left: auto; margin-right: auto; }
    #prix { font-size: 28px; font-weight: bold; color: #222; text-align: left; margin-bottom: 5px; }
    #coutant { font-size: 20px; color: #555; font-style: italic; text-align: left; }
    .incomplet { color: #b00020; font-size: 16px; font-weight: bold; }
    .card { margin: 20px auto; padding: 20px; border-radius: 12px; max-width: 500px; background: #f0f0f0; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .erreur { border: 2px solid red !important; background: #ffecec; }
    #blocPrixManuel { margin-top:15px; text-align:left; display:none; }

    /* Champ $ */
    .input-dollar {
      display: flex;
      align-items: center;
      border: 1px solid #bbb;
      border-radius: 6px;
      background: #fff;
      padding: 0 8px;
      max-width: 200px;
    }
    .input-dollar span { font-size: 16px; color: #555; margin-right: 5px; }
    .input-dollar input { border: none; outline: none; flex: 1; padding: 6px; font-size: 14px; }

    /* Champ KM */
    .input-km {
      display: flex;
      align-items: center;
      border: 1px solid #bbb;
      border-radius: 6px;
      background: #fff;
      padding: 0 8px;
      overflow: hidden;
    }
    .input-km input { border: none; outline: none; flex: 1; padding: 6px; font-size: 14px; }
    .input-km span { font-size: 14px; color: #555; margin-left: 5px; white-space: nowrap; }
    .input-km.erreur { border: 2px solid red !important; background: #ffecec; border-radius: 6px; }
    .input-km.erreur input { background: transparent; }
    .input-km.erreur span { background: transparent; }

    /* Modale de confirmation */
    .modal {
      display: none; 
      position: fixed;
      z-index: 1000; 
      left: 0; top: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5); 
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: #fff;
      padding: 25px 30px;
      border-radius: 16px;
      text-align: center;
      max-width: 400px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.25);
      animation: fadeIn 0.3s ease;
      border-top: 6px solid #D7F502;
    }
    .modal-content p {
      font-size: 18px;
      margin-bottom: 20px;
      color: #222;
    }
    .modal-actions {
      display: flex;
      justify-content: space-around;
      gap: 15px;
    }
    .btn-confirm {
      background: #D7F502;
      color: #222;
      border: none;
      padding: 10px 22px;
      font-size: 16px;
      font-weight: bold;
      border-radius: 8px;
      cursor: pointer;
      transition: 0.2s;
    }
    .btn-confirm:hover { background: #c4df00; }
    .btn-cancel {
      background: #eee;
      color: #444;
      border: none;
      padding: 10px 22px;
      font-size: 16px;
      font-weight: bold;
      border-radius: 8px;
      cursor: pointer;
      transition: 0.2s;
    }
    .btn-cancel:hover { background: #ccc; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>Calculateur – Prix transport</h1>
    <img src="logo-lsm.png" alt="LSM Logo">
  </div>

  <!-- Formulaire -->
  <form id="formCalc" onsubmit="event.preventDefault(); calculer(true);">
    <table>
      <tr><th colspan="2">Informations principales</th></tr>
      <tr>
        <td><label>Succursale de départ</label></td>
        <td>
          <select id="succursale" onchange="majAuto()">
            <option value="">--Choisir--</option>
            <option value="Montréal">Montréal</option>
            <option value="Québec">Québec</option>
            <option value="STHY">STHY</option>
            <option value="Saguenay">Saguenay</option>
          </select>
        </td>
      </tr>
      <tr>
        <td><label>Kilométrage (aller simple)</label></td>
        <td>
          <div class="input-km">
            <input type="number" id="km" min="0" step="5" placeholder="Kilométrage (aller simple)" oninput="majAuto()">
            <span>KM</span>
          </div>
        </td>
      </tr>
      <tr>
        <td><label>Horaire du IN</label></td>
        <td>
          <select id="horaireAller" onchange="majAuto()">
            <option value="">--Choisir--</option>
            <option>Heures ouvrables (7h @ 17h)</option>
            <option>Soir (17h @ 21h)</option>
            <option>Nuit (21h @ 6h) et FDS</option>
            <option>Jour férié</option>
          </select>
        </td>
      </tr>
      <tr>
        <td><label>Horaire du OUT</label></td>
        <td>
          <select id="horaireRetour" onchange="majAuto()">
            <option value="">--Choisir--</option>
            <option value="NA">N/A</option>
            <option>Heures ouvrables (7h @ 17h)</option>
            <option>Soir (17h @ 21h)</option>
            <option>Nuit (21h @ 6h) et FDS</option>
            <option>Jour férié</option>
          </select>
          <small style="color:#666; font-size:12px;">Choisir « N/A » s’il n’y a pas de ramassage</small>
        </td>
      </tr>
      <tr>
        <td><label>Accompagnateur(s) (Total)</label></td>
        <td>
          <select id="accomp" onchange="majAuto()">
            <option value="">Aucun</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
          </select>
        </td>
      </tr>
    </table>

    <table>
      <tr><th colspan="2">Véhicules</th></tr>
      <tr>
        <td><label>Véhicule de service</label></td>
        <td><input type="number" id="vehService" min="0" step="1" value="0" oninput="majAuto()"></td>
      </tr>
      <tr>
        <td><label>Hino 20 pi</label></td>
        <td><input type="number" id="hino20" min="0" step="1" value="0" oninput="majAuto()"></td>
      </tr>
      <tr>
        <td><label>Hino 26 pi</label></td>
        <td><input type="number" id="hino26" min="0" step="1" value="0" oninput="majAuto()"></td>
      </tr>
    </table>

    <button class="btn" type="submit">Calculer</button>
    <button class="btn" type="button" onclick="resetForm()">Réinitialiser</button>
    <input type="submit" hidden>
  </form>

  <div class="card result">
    <div id="prix"></div>
    <div id="coutant"></div>
    <div id="blocPrixManuel">
      <label for="prixManuel">Modification manuelle du prix :</label>
      <div class="input-dollar">
        <span>$</span>
        <input type="number" id="prixManuel" step="10" oninput="majPrixManuel()">
      </div>
    </div>
  </div>

  <!-- Modale -->
  <div id="confirmModal" class="modal">
    <div class="modal-content">
      <p>Voulez-vous vraiment réinitialiser le formulaire ?</p>
      <div class="modal-actions">
        <button id="confirmYes" class="btn-confirm">Oui</button>
        <button id="confirmNo" class="btn-cancel">Non</button>
      </div>
    </div>
  </div>

<script>
const MOD_L9 = 0.43;
const MARGE = 0.30;
const F_VEH_SERVICE = 0.4905418989;
const F_HINO20 = 0.6862011817;
const F_HINO26 = 0.8983935605;

let aDejaCalcule = false;

function facteurSuccursale(s) {
  if (s === "Montréal") return 1.8;
  if (s === "Québec") return 1.4;
  if (s === "STHY") return 1.2;
  if (s === "Saguenay") return 1.0;
  return 1.0;
}

function flatRateSuccursale(s) {
  if (s === "Montréal") return 400;
  if (s === "Québec") return 350;
  if (s === "STHY") return 300;
  if (s === "Saguenay") return 250;
  return 250;
}

function supHoraire(h, km, heures, multAccomp) {
  if (h === "Soir (17h @ 21h)") return km * MOD_L9 * 2 * heures * multAccomp;
  if (h === "Nuit (21h @ 6h) et FDS" || h === "Jour férié") return km * MOD_L9 * 2 * 2 * heures * multAccomp;
  return 0;
}

function majAuto() {
  if (aDejaCalcule) calculer(false);
}

function getCouleurMarge(margeReelle) {
  if (margeReelle >= 30) return "green";
  if (margeReelle > 0) return "orange";
  return "red";
}

function calculer(force) {
  if (force) aDejaCalcule = true;

  const succ = document.getElementById("succursale").value;
  const km = parseFloat(document.getElementById("km").value) || 0;
  const horaireAller = document.getElementById("horaireAller").value;
  const horaireRetour = document.getElementById("horaireRetour").value;
  const accompVal = document.getElementById("accomp").value;
  const accomp = accompVal === "" ? 0 : parseInt(accompVal, 10);

  const vehService = parseInt(document.getElementById("vehService").value) || 0;
  const h20 = parseInt(document.getElementById("hino20").value) || 0;
  const h26 = parseInt(document.getElementById("hino26").value) || 0;

  const nbHeures = vehService + h20 + h26;

  // reset styles
  document.getElementById("succursale").classList.remove("erreur");
  document.querySelector(".input-km").classList.remove("erreur");
  document.getElementById("horaireAller").classList.remove("erreur");
  document.getElementById("horaireRetour").classList.remove("erreur");
  document.getElementById("vehService").classList.remove("erreur");
  document.getElementById("hino20").classList.remove("erreur");
  document.getElementById("hino26").classList.remove("erreur");

  // validation
  let incomplet = false;
  if (!succ) { document.getElementById("succursale").classList.add("erreur"); incomplet = true; }
  if (km === 0) { document.querySelector(".input-km").classList.add("erreur"); incomplet = true; }
  if (!horaireAller) { document.getElementById("horaireAller").classList.add("erreur"); incomplet = true; }
  if (horaireRetour === "") { document.getElementById("horaireRetour").classList.add("erreur"); incomplet = true; }
  if (nbHeures === 0) {
    document.getElementById("vehService").classList.add("erreur");
    document.getElementById("hino20").classList.add("erreur");
    document.getElementById("hino26").classList.add("erreur");
    incomplet = true;
  }

  if (incomplet) {
    document.getElementById("prix").innerHTML = "<span class='incomplet'>*Données incomplètes</span>";
    document.getElementById("coutant").innerHTML = "";
    document.getElementById("coutant").dataset.value = "";
    document.getElementById("blocPrixManuel").style.display = "none";
    return;
  }

  const facteur = facteurSuccursale(succ);
  const nbAR = (horaireRetour && horaireRetour !== "NA") ? 4 : 2;
  const multAccomp = 1 + accomp;

  let sup = 0;
  sup += supHoraire(horaireAller, km, nbHeures, multAccomp);
  if (horaireRetour && horaireRetour !== "NA") sup += supHoraire(horaireRetour, km, nbHeures, multAccomp);

  let coutantCalc = (facteur * MOD_L9 * km * nbAR * nbHeures * multAccomp) +
                    (vehService * F_VEH_SERVICE * km * nbAR) +
                    (h20 * F_HINO20 * km * nbAR) +
                    (h26 * F_HINO26 * km * nbAR) +
                    sup;

  const flatRate = flatRateSuccursale(succ);
  const prix = Math.max(coutantCalc * (1 + MARGE), flatRate);
  const margeReelle = ((prix - coutantCalc) / coutantCalc) * 100;
  const couleurMarge = getCouleurMarge(margeReelle);

  document.getElementById("prix").innerHTML = 
    "PRIX : " + prix.toFixed(2) + " $ <span style='font-size:18px; color:" + couleurMarge + ";'>(Marge : " + margeReelle.toFixed(1) + "%)</span>";
  document.getElementById("coutant").innerHTML = "Coûtant : " + coutantCalc.toFixed(2) + " $";
  document.getElementById("coutant").dataset.value = coutantCalc;

  document.getElementById("blocPrixManuel").style.display = "block";

  saveFormData();
}

function majPrixManuel() {
  const coutantCalc = parseFloat
